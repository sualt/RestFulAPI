<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8" />
    <title>Ürün Yönetimi</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
          rel="stylesheet"
          integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
          crossorigin="anonymous" />

    <style>
        body {
            background-color: #f5f5f5;
        }
    </style>
</head>
<body>
    <div class="container py-4">
        <h1 class="mb-4 text-center">Ürün Yönetimi</h1>

        <!-- FORM KISMI -->
        <div class="card mb-4">
            <div class="card-header">
                <span id="form-title">Yeni Ürün Ekle</span>
            </div>
            <div class="card-body">
                <!-- Güncelleme için gizli Id -->
                <input type="hidden" id="productId" />

                <div class="row g-3">
                    <div class="col-md-4">
                        <label for="name" class="form-label">Ürün Adı</label>
                        <input type="text" id="name" class="form-control" placeholder="Örn: Kalem" />
                    </div>
                    <div class="col-md-4">
                        <label for="price" class="form-label">Fiyat</label>
                        <input type="number" id="price" class="form-control" step="0.01" placeholder="Örn: 12.50" />
                    </div>
                    <div class="col-md-4">
                        <label for="stock" class="form-label">Stok</label>
                        <input type="number" id="stock" class="form-control" placeholder="Örn: 100" />
                    </div>
                </div>

                <div class="mt-3 d-flex gap-2">
                    <button id="saveBtn" class="btn btn-primary" onclick="saveProduct()">Ekle</button>
                    <button class="btn btn-secondary" onclick="resetForm()">Temizle</button>
                </div>
            </div>
        </div>

        <!-- TABLO KISMI -->
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span>Ürün Listesi</span>
                <button class="btn btn-outline-primary btn-sm" onclick="loadProducts()">
                    Yenile
                </button>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-striped mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Id</th>
                                <th>Ad</th>
                                <th>Fiyat</th>
                                <th>Stok</th>
                                <th style="width: 160px;">İşlemler</th>
                            </tr>
                        </thead>
                        <tbody id="products-body">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
            crossorigin="anonymous"></script>

    <script>
        let productsCache = [];
        let editMode = false; // false = ekleme, true = güncelleme

        window.onload = function () {
            loadProducts();
        };

        // ÜRÜNLERİ GETİR (GET /api/Products)
        async function loadProducts() {
            try {
                const response = await fetch('/api/Products');
                if (!response.ok) {
                    throw new Error('HTTP hata kodu: ' + response.status);
                }

                const data = await response.json();
                productsCache = data;

                const tbody = document.getElementById('products-body');
                tbody.innerHTML = '';

                if (data.length === 0) {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `<td colspan="5" class="text-center py-3">Hiç ürün yok. Formdan ekleyebilirsin.</td>`;
                    tbody.appendChild(tr);
                    return;
                }

                data.forEach(p => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                            <td>${p.id}</td>
                            <td>${p.name}</td>
                            <td>${p.price}</td>
                            <td>${p.stock}</td>
                            <td>
                                <button class="btn btn-sm btn-warning me-1" onclick="editProduct(${p.id})">
                                    Düzenle
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="deleteProduct(${p.id})">
                                    Sil
                                </button>
                            </td>
                        `;
                    tbody.appendChild(tr);
                });

            } catch (err) {
                console.error(err);
                alert('Ürünler yüklenirken bir hata oluştu: ' + err.message);
            }
        }

        // KAYDET (EKLE VEYA GÜNCELLE)
        async function saveProduct() {
            const idVal = document.getElementById('productId').value;
            const name = document.getElementById('name').value.trim();
            const priceVal = document.getElementById('price').value;
            const stockVal = document.getElementById('stock').value;

            const price = parseFloat(priceVal);
            const stock = parseInt(stockVal);

            if (!name || isNaN(price) || isNaN(stock)) {
                alert('Lütfen tüm alanları geçerli şekilde doldurun.');
                return;
            }

            const product = { name, price, stock };

            try {
                let response;
                if (!editMode) {
                    // EKLEME (POST)
                    response = await fetch('/api/Products', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(product)
                    });
                } else {
                    // GÜNCELLEME (PUT /api/Products/{id})
                    const id = parseInt(idVal);
                    product.id = id;

                    response = await fetch('/api/Products/' + id, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(product)
                    });
                }

                if (!response.ok) {
                    throw new Error('Sunucu hatası: ' + response.status);
                }

                resetForm();
                loadProducts();

            } catch (err) {
                console.error(err);
                alert('Kayıt sırasında hata: ' + err.message);
            }
        }

        // DÜZENLEME MODUNA AL
        function editProduct(id) {
            const product = productsCache.find(p => p.id === id);
            if (!product) {
                alert('Ürün bulunamadı.');
                return;
            }

            editMode = true;
            document.getElementById('productId').value = product.id;
            document.getElementById('name').value = product.name;
            document.getElementById('price').value = product.price;
            document.getElementById('stock').value = product.stock;

            document.getElementById('saveBtn').innerText = 'Güncelle';
            document.getElementById('saveBtn').classList.remove('btn-primary');
            document.getElementById('saveBtn').classList.add('btn-success');
            document.getElementById('form-title').innerText = 'Ürünü Güncelle';
        }

        // SİL (DELETE /api/Products/{id})
        async function deleteProduct(id) {
            const onay = confirm('Bu ürünü silmek istediğine emin misin?');
            if (!onay) return;

            try {
                const response = await fetch('/api/Products/' + id, {
                    method: 'DELETE'
                });

                if (!response.ok) {
                    throw new Error('Sunucu hatası: ' + response.status);
                }

                loadProducts();
            } catch (err) {
                console.error(err);
                alert('Silme sırasında hata: ' + err.message);
            }
        }

        // FORMU TEMİZLE VE EKLE MODUNA DÖN
        function resetForm() {
            editMode = false;
            document.getElementById('productId').value = '';
            document.getElementById('name').value = '';
            document.getElementById('price').value = '';
            document.getElementById('stock').value = '';

            document.getElementById('saveBtn').innerText = 'Ekle';
            document.getElementById('saveBtn').classList.remove('btn-success');
            document.getElementById('saveBtn').classList.add('btn-primary');
            document.getElementById('form-title').innerText = 'Yeni Ürün Ekle';
        }
    </script>
</body>
</html>
